FROM golang
MAINTAINER Kamesh Balasubramanian kamesh@kamesh.com

# Declare required environment variables
ENV IGWEB_APP_ROOT=/go/src/github.com/EngineerKamesh/igb/igweb
ENV IGWEB_DB_CONNECTION_STRING="database:6379"
ENV IGWEB_MODE=production
ENV GOPATH=/go

# Get the required Go packages
RUN go get -u github.com/gopherjs/gopherjs
RUN go get -u honnef.co/go/js/dom
RUN go get -u -d -tags=js github.com/gopherjs/jsbuiltin
RUN go get -u honnef.co/go/js/xhr
RUN go get -u github.com/gopherjs/websocket
RUN go get -u github.com/isomorphicgo/isokit 
RUN go get -u github.com/uxtoolkit/cog
RUN go get -u github.com/EngineerKamesh/igb

# Transpile the client-side application code
RUN cd $IGWEB_APP_ROOT/client; go get ./..; gopherjs build -m -o $IGWEB_APP_ROOT/static/js/client.js

# Build and install the server-side application code
RUN go install github.com/EngineerKamesh/igb/igweb

# Copy the pre-generated static assets
# Note: These set of COPY instructions are meant for initial demonstration purposes only. It should be removed once
# active development of cogs and/or template files has begun.
COPY ./deployments-config/default_static_assets/cogimports.css $IGWEB_APP_ROOT/static/css/cogimports.css
COPY ./deployments-config/default_static_assets/cogimports.js $IGWEB_APP_ROOT/static/js/cogimports.js
COPY ./deployments-config/default_static_assets/igweb.tmplbundle $IGWEB_APP_ROOT/static/templates/igweb.tmplbundle

# Copy the generated static assets
# Note: These set of COPY instructions are meant for active development of cogs and/or templates. It should be
# used once static assets have been generated by running the igweb application locally.
#COPY ./static/css/cogimports.css $IGWEB_APP_ROOT/static/css/cogimports.css
#COPY ./static/js/cogimports.js $IGWEB_APP_ROOT/static/js/cogimports.js
#COPY ./static/templates/igweb.tmplbundle $IGWEB_APP_ROOT/static/templates/igweb.tmplbundle

# Specify the entrypoint
ENTRYPOINT /go/bin/igweb

# Expose port 8080 of the container
EXPOSE 8080
